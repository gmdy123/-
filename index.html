<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学校建筑规模测算系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            success: '#00B42A',
            danger: '#F53F3F',
            neutral: '#F5F7FA',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .input-focus {
        @apply focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none;
      }
      .transition-all-300 {
        transition: all 300ms ease-in-out;
      }
      .action-buttons {
        @apply fixed bottom-6 right-6 flex gap-3 z-10;
      }
      .action-btn {
        @apply w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all duration-300 hover:scale-105;
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- 标题区域 -->
    <header class="mb-8 text-center">
      <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-gray-800 mb-2">学校建筑规模测算系统</h1>
      <p class="text-gray-500">基于学生数量及类型的建筑规模缺额测算工具</p>
    </header>
    
    <!-- 主内容区 -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- 左侧：输入区域 -->
      <div class="lg:col-span-2 space-y-6">
        <!-- 学校类型选择 -->
        <div class="bg-white rounded-xl p-6 shadow-md">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-university text-primary mr-2"></i>学校类型
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-neutral transition-all-300">
              <input type="radio" name="schoolType" value="X" class="w-4 h-4 text-primary" checked>
              <span class="ml-2">综合师范（X）</span>
            </label>
            <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-neutral transition-all-300">
              <input type="radio" name="schoolType" value="Y" class="w-4 h-4 text-primary">
              <span class="ml-2">工科医学农林（Y）</span>
            </label>
            <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-neutral transition-all-300">
              <input type="radio" name="schoolType" value="Z" class="w-4 h-4 text-primary">
              <span class="ml-2">政法财经外语（Z）</span>
            </label>
            <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-neutral transition-all-300">
              <input type="radio" name="schoolType" value="M" class="w-4 h-4 text-primary">
              <span class="ml-2">艺术（M）</span>
            </label>
            <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-neutral transition-all-300">
              <input type="radio" name="schoolType" value="T" class="w-4 h-4 text-primary">
              <span class="ml-2">体育（T）</span>
            </label>
          </div>
        </div>
        
        <!-- 学生数量输入 -->
        <div class="bg-white rounded-xl p-6 shadow-md">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-users text-primary mr-2"></i>学生数量（人）
          </h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">本专科生</label>
              <input type="number" id="undergraduates" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">硕士生</label>
              <input type="number" id="masters" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">博士生</label>
              <input type="number" id="doctors" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
          </div>
          
          <h3 class="text-lg font-medium mb-3">留学生</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">本科留学生</label>
              <input type="number" id="intlUndergrad" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">硕士留学生</label>
              <input type="number" id="intlMasters" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">博士留学生</label>
              <input type="number" id="intlDoctors" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
          </div>
          
          <div class="mt-4 p-3 bg-neutral rounded-lg">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium">留学生总数</span>
              <span id="intlTotal" class="text-primary font-semibold">0</span>
            </div>
          </div>
        </div>
        
        <!-- 现状面积输入 -->
        <div class="bg-white rounded-xl p-6 shadow-md">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-building text-primary mr-2"></i>现状建筑面积（㎡）
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">教学及辅助用房（A）</label>
              <input type="number" id="currentA" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">办公用房（B）</label>
              <input type="number" id="currentB" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">生活配套用房（C）</label>
              <input type="number" id="currentC" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
              <p class="text-xs text-gray-500 mt-1">提示：C应等于c1+c2</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">学生宿舍（c1）</label>
              <input type="number" id="currentC1" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">其他生活用房（c2）</label>
              <input type="number" id="currentC2" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">后勤辅助用房（D）</label>
              <input type="number" id="currentD" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus" min="0" value="0">
            </div>
          </div>
        </div>
        
        <!-- 补贴面积 -->
        <div class="bg-white rounded-xl p-6 shadow-md">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold flex items-center">
              <i class="fa fa-handshake-o text-primary mr-2"></i>补贴面积
            </h2>
            <button id="toggleSubsidy" class="text-primary text-sm flex items-center">
              <span id="subsidyToggleText">展开</span>
              <i id="subsidyToggleIcon" class="fa fa-chevron-down ml-1 transition-transform duration-300"></i>
            </button>
          </div>
          
          <div id="subsidyContent" class="hidden space-y-3">
            <div id="subsidyList">

            </div>
            <button id="addSubsidy" type="button" class="mt-2 px-4 py-2 bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition-colors flex items-center">
              <i class="fa fa-plus mr-2"></i>添加补贴
            </button>
            <div class="mt-4 p-3 bg-neutral rounded-lg">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium">补贴总面积</span>
                <span id="totalSubsidy" class="text-primary font-semibold">0</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 人均指标说明 -->
        <div class="bg-white rounded-xl p-6 shadow-md">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold flex items-center">
              <i class="fa fa-info-circle text-primary mr-2"></i>人均建筑面积指标说明
            </h2>
            <button id="toggleIndicators" class="text-primary text-sm flex items-center">
              <span id="indicatorsToggleText">展开</span>
              <i id="indicatorsToggleIcon" class="fa fa-chevron-down ml-1 transition-transform duration-300"></i>
            </button>
          </div>
          
          <div id="indicatorsContent" class="hidden overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead>
                <tr>
                  <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学校类型</th>
                  <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">教学及辅助用房（A）</th>
                  <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">办公用房（B）</th>
                  <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">生活配套用房（C）</th>
                  <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">其中：宿舍（c1）</th>
                  <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">其中：其他（c2）</th>
                  <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">后勤辅助用房（D）</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr>
                  <td class="px-3 py-2 text-sm">综合师范（X）</td>
                  <td class="px-3 py-2 text-sm">12.95 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">2 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">12 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">10 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">2 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">1.55 ㎡/生</td>
                </tr>
                <tr>
                  <td class="px-3 py-2 text-sm">工科医学农林（Y）</td>
                  <td class="px-3 py-2 text-sm">15.95 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">2 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">12 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">10 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">2 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">1.55 ㎡/生</td>
                </tr>
                <tr>
                  <td class="px-3 py-2 text-sm">政法财经外语（Z）</td>
                  <td class="px-3 py-2 text-sm">7.95 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">2 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">12 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">10 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">2 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">1.55 ㎡/生</td>
                </tr>
                <tr>
                  <td class="px-3 py-2 text-sm">艺术（M）</td>
                  <td class="px-3 py-2 text-sm">53.5 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">3.5 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">12.5 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">10 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">2.5 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">2 ㎡/生</td>
                </tr>
                <tr>
                  <td class="px-3 py-2 text-sm">体育（T）</td>
                  <td class="px-3 py-2 text-sm">22 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">2.2 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">12 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">10 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">2 ㎡/生</td>
                  <td class="px-3 py-2 text-sm">1.8 ㎡/生</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- 右侧：结果区域 -->
      <div class="lg:col-span-1 space-y-6">
        <!-- 测算结果 -->
        <div class="bg-white rounded-xl p-6 shadow-md sticky top-4">
          <h2 class="text-xl font-semibold mb-6 flex items-center">
            <i class="fa fa-calculator text-primary mr-2"></i>测算结果
          </h2>
          
          <button id="calculateBtn" class="w-full py-3 bg-primary text-white rounded-lg font-medium mb-6 hover:bg-primary/90 transition-colors flex items-center justify-center">
            <i class="fa fa-refresh mr-2"></i>计算缺额
          </button>
          
          <!-- 总体缺额和含补贴总体缺额 -->
          <div class="space-y-3 mb-6">
            <div class="p-4 bg-neutral rounded-lg border border-gray-200">
              <div class="flex justify-between items-center">
                <span class="font-medium">总体缺额</span>
                <span id="totalDeficit" class="font-semibold text-lg">-</span>
              </div>
            </div>
            
            <div class="p-4 bg-primary/10 rounded-lg border border-primary/20">
              <div class="flex justify-between items-center">
                <span class="font-medium text-primary">含补贴总体缺额</span>
                <span id="totalDeficitWithSubsidy" class="font-semibold text-lg text-primary">-</span>
              </div>
            </div>
          </div>
          
          <!-- 分类缺额 -->
          <div class="space-y-3 mb-6">
            <div class="p-3 border border-gray-100 rounded-lg">
              <div class="flex justify-between items-center">
                <span class="text-sm">教学及辅助用房（A）缺额</span>
                <span id="deficitA" class="font-medium">-</span>
              </div>
            </div>
            
            <div class="p-3 border border-gray-100 rounded-lg">
              <div class="flex justify-between items-center">
                <span class="text-sm">办公用房（B）缺额</span>
                <span id="deficitB" class="font-medium">-</span>
              </div>
            </div>
            
            <div class="p-3 border border-gray-100 rounded-lg">
              <div class="flex justify-between items-center">
                <span class="text-sm">生活配套用房（C）缺额</span>
                <span id="deficitC" class="font-medium">-</span>
              </div>
            </div>
            
            <div class="p-3 border border-gray-100 rounded-lg">
              <div class="flex justify-between items-center">
                <span class="text-sm">学生宿舍（c1）缺额</span>
                <span id="deficitC1" class="font-medium">-</span>
              </div>
            </div>
            
            <div class="p-3 border border-gray-100 rounded-lg">
              <div class="flex justify-between items-center">
                <span class="text-sm">其他生活用房（c2）缺额</span>
                <span id="deficitC2" class="font-medium">-</span>
              </div>
            </div>
            
            <div class="p-3 border border-gray-100 rounded-lg">
              <div class="flex justify-between items-center">
                <span class="text-sm">后勤辅助用房（D）缺额</span>
                <span id="deficitD" class="font-medium">-</span>
              </div>
            </div>
          </div>
          
          <div class="mt-6 pt-4 border-t border-gray-100">
            <h3 class="text-sm font-medium mb-3">各类用房应配建规模</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">教学及辅助用房（A）</span>
                <span id="requiredA">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">办公用房（B）</span>
                <span id="requiredB">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">生活配套用房（C）</span>
                <span id="requiredC">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">学生宿舍（c1）</span>
                <span id="requiredC1">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">其他生活用房（c2）</span>
                <span id="requiredC2">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">后勤辅助用房（D）</span>
                <span id="requiredD">-</span>
              </div>
              <!-- 应配建规模总额 -->
              <div class="mt-2 pt-2 border-t border-gray-100 flex justify-between font-medium">
                <span>总应配建规模（不含补贴）</span>
                <span id="totalRequired" class="text-primary">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <footer class="mt-12 text-center text-gray-500 text-sm py-4">
      <p>学校建筑规模测算系统 &copy; 2023 | 核心逻辑：生活配套用房C = 学生宿舍c1 + 其他生活用房c2</p>
    </footer>
  </div>

  <!-- 右下角操作按钮 -->
  <div class="action-buttons">
    <button id="refreshBtn" class="action-btn bg-white text-gray-700 hover:bg-gray-100" title="刷新数据">
      <i class="fa fa-refresh"></i>
    </button>
    <button id="exportBtn" class="action-btn bg-primary text-white hover:bg-primary/90" title="导出CSV">
      <i class="fa fa-download"></i>
    </button>
  </div>

  <script>
    // 指标数据（包含c1和c2的固定值，确保C = c1 + c2）
    const indicators = {
      X: { A: 12.95, B: 2, C: 12, C1: 10, C2: 2, D: 1.55 },       // 12 = 10 + 2
      Y: { A: 15.95, B: 2, C: 12, C1: 10, C2: 2, D: 1.55 },       // 12 = 10 + 2
      Z: { A: 7.95, B: 2, C: 12, C1: 10, C2: 2, D: 1.55 },        // 12 = 10 + 2
      M: { A: 53.5, B: 3.5, C: 12.5, C1: 10, C2: 2.5, D: 2 },     // 12.5 = 10 + 2.5
      T: { A: 22, B: 2.2, C: 12, C1: 10, C2: 2, D: 1.8 }          // 12 = 10 + 2
    };
    
    // DOM元素
    const elements = {
      // 学生数量
      undergraduates: document.getElementById('undergraduates'),
      masters: document.getElementById('masters'),
      doctors: document.getElementById('doctors'),
      intlUndergrad: document.getElementById('intlUndergrad'),
      intlMasters: document.getElementById('intlMasters'),
      intlDoctors: document.getElementById('intlDoctors'),
      intlTotal: document.getElementById('intlTotal'),
      
      // 现状面积
      currentA: document.getElementById('currentA'),
      currentB: document.getElementById('currentB'),
      currentC: document.getElementById('currentC'),
      currentC1: document.getElementById('currentC1'),
      currentC2: document.getElementById('currentC2'),
      currentD: document.getElementById('currentD'),
      
      // 补贴
      toggleSubsidy: document.getElementById('toggleSubsidy'),
      subsidyContent: document.getElementById('subsidyContent'),
      subsidyToggleText: document.getElementById('subsidyToggleText'),
      subsidyToggleIcon: document.getElementById('subsidyToggleIcon'),
      addSubsidy: document.getElementById('addSubsidy'),
      subsidyList: document.getElementById('subsidyList'),
      totalSubsidy: document.getElementById('totalSubsidy'),
      
      // 指标说明
      toggleIndicators: document.getElementById('toggleIndicators'),
      indicatorsContent: document.getElementById('indicatorsContent'),
      indicatorsToggleText: document.getElementById('indicatorsToggleText'),
      indicatorsToggleIcon: document.getElementById('indicatorsToggleIcon'),
      
      // 计算按钮
      calculateBtn: document.getElementById('calculateBtn'),
      
      // 结果
      deficitA: document.getElementById('deficitA'),
      deficitB: document.getElementById('deficitB'),
      deficitC: document.getElementById('deficitC'),
      deficitC1: document.getElementById('deficitC1'),
      deficitC2: document.getElementById('deficitC2'),
      deficitD: document.getElementById('deficitD'),
      totalDeficit: document.getElementById('totalDeficit'),
      totalDeficitWithSubsidy: document.getElementById('totalDeficitWithSubsidy'),
      
      // 应配建规模
      requiredA: document.getElementById('requiredA'),
      requiredB: document.getElementById('requiredB'),
      requiredC: document.getElementById('requiredC'),
      requiredC1: document.getElementById('requiredC1'),
      requiredC2: document.getElementById('requiredC2'),
      requiredD: document.getElementById('requiredD'),
      totalRequired: document.getElementById('totalRequired'),
      
      // 操作按钮
      refreshBtn: document.getElementById('refreshBtn'),
      exportBtn: document.getElementById('exportBtn')
    };
    
    // 更新留学生总数
    function updateIntlTotal() {
      const undergrad = parseInt(elements.intlUndergrad.value) || 0;
      const masters = parseInt(elements.intlMasters.value) || 0;
      const doctors = parseInt(elements.intlDoctors.value) || 0;
      elements.intlTotal.textContent = (undergrad + masters + doctors).toString();
    }
    
    // 更新补贴总面积
    function updateTotalSubsidy() {
      const count = elements.subsidyList.querySelectorAll('.subsidy-item').length;
      elements.totalSubsidy.textContent = (count * 3000) + '㎡';
      return count * 3000;
    }
    
    // 切换补贴区域显示/隐藏
    elements.toggleSubsidy.addEventListener('click', () => {
      elements.subsidyContent.classList.toggle('hidden');
      if (elements.subsidyContent.classList.contains('hidden')) {
        elements.subsidyToggleText.textContent = '展开';
        elements.subsidyToggleIcon.classList.remove('rotate-180');
      } else {
        elements.subsidyToggleText.textContent = '收起';
        elements.subsidyToggleIcon.classList.add('rotate-180');
      }
    });
    
    // 切换指标说明显示/隐藏
    elements.toggleIndicators.addEventListener('click', () => {
      elements.indicatorsContent.classList.toggle('hidden');
      if (elements.indicatorsContent.classList.contains('hidden')) {
        elements.indicatorsToggleText.textContent = '展开';
        elements.indicatorsToggleIcon.classList.remove('rotate-180');
      } else {
        elements.indicatorsToggleText.textContent = '收起';
        elements.indicatorsToggleIcon.classList.add('rotate-180');
      }
    });
    
    // 添加补贴项
    elements.addSubsidy.addEventListener('click', () => {
      const newItem = document.createElement('div');
      newItem.className = 'subsidy-item grid grid-cols-10 gap-2 items-end';
      newItem.innerHTML = `
        <input type="text" placeholder="补贴名称" class="col-span-7 px-3 py-2 border border-gray-300 rounded-lg input-focus">
        <div class="col-span-2 text-center py-2 bg-neutral rounded-lg">3000㎡</div>
        <button type="button" class="remove-subsidy col-span-1 text-gray-400 hover:text-danger transition-colors">
          <i class="fa fa-trash"></i>
        </button>
      `;
      elements.subsidyList.appendChild(newItem);
      
      // 添加删除事件
      newItem.querySelector('.remove-subsidy').addEventListener('click', () => {
        elements.subsidyList.removeChild(newItem);
        updateTotalSubsidy();
      });
      
      updateTotalSubsidy();
    });
    
    // 删除补贴项
    document.addEventListener('click', (e) => {
      if (e.target.closest('.remove-subsidy')) {
        const item = e.target.closest('.subsidy-item');
        elements.subsidyList.removeChild(item);
        updateTotalSubsidy();
      }
    });
    
    // 计算缺额
    elements.calculateBtn.addEventListener('click', calculateDeficit);
    
    // 输入变化时更新留学生总数
    [elements.intlUndergrad, elements.intlMasters, elements.intlDoctors].forEach(el => {
      el.addEventListener('input', updateIntlTotal);
    });
    
    // 刷新按钮功能
    elements.refreshBtn.addEventListener('click', () => {
      // 重置学生数量输入
      elements.undergraduates.value = '0';
      elements.masters.value = '0';
      elements.doctors.value = '0';
      elements.intlUndergrad.value = '0';
      elements.intlMasters.value = '0';
      elements.intlDoctors.value = '0';
      updateIntlTotal();
      
      // 重置现状面积输入
      elements.currentA.value = '0';
      elements.currentB.value = '0';
      elements.currentC.value = '0';
      elements.currentC1.value = '0';
      elements.currentC2.value = '0';
      elements.currentD.value = '0';
      
      // 清空补贴项
      elements.subsidyList.innerHTML = '';
      updateTotalSubsidy();
      elements.subsidyContent.classList.add('hidden');
      elements.subsidyToggleText.textContent = '展开';
      elements.subsidyToggleIcon.classList.remove('rotate-180');
      
      // 重置结果显示
      elements.deficitA.innerHTML = '-';
      elements.deficitB.innerHTML = '-';
      elements.deficitC.innerHTML = '-';
      elements.deficitC1.innerHTML = '-';
      elements.deficitC2.innerHTML = '-';
      elements.deficitD.innerHTML = '-';
      elements.totalDeficit.textContent = '-';
      elements.totalDeficitWithSubsidy.textContent = '-';
      elements.requiredA.textContent = '-';
      elements.requiredB.textContent = '-';
      elements.requiredC.textContent = '-';
      elements.requiredC1.textContent = '-';
      elements.requiredC2.textContent = '-';
      elements.requiredD.textContent = '-';
      elements.totalRequired.textContent = '-';
      
      // 提示刷新完成
      alert('数据已重置为初始状态');
    });
    
    // 导出CSV功能
    elements.exportBtn.addEventListener('click', () => {
      // 获取学校类型文本（如"综合师范（X）"）
      const schoolTypeValue = document.querySelector('input[name="schoolType"]:checked').value;
      const schoolTypeText = {
        X: '综合师范（X）',
        Y: '工科医学农林（Y）',
        Z: '政法财经外语（Z）',
        M: '艺术（M）',
        T: '体育（T）'
      }[schoolTypeValue];
      
      // 收集学生数据
      const studentData = {
        本专科生: elements.undergraduates.value || '0',
        硕士生: elements.masters.value || '0',
        博士生: elements.doctors.value || '0',
        本科留学生: elements.intlUndergrad.value || '0',
        硕士留学生: elements.intlMasters.value || '0',
        博士留学生: elements.intlDoctors.value || '0'
      };
      
      // 收集补贴数据
      const subsidyArea = elements.totalSubsidy.textContent || '0㎡';
      
      // 收集应配建、现状、缺额数据（处理未计算的情况）
      const getValue = (el) => {
        const text = el.textContent.trim();
        return text === '-' ? '0.00㎡' : text;
      };
      
      const buildingData = [
        {
          类型: '教学及辅助用房（A）',
          应配建: getValue(elements.requiredA),
          现状: elements.currentA.value + '㎡',
          缺额: getValue(elements.deficitA)
        },
        {
          类型: '办公用房（B）',
          应配建: getValue(elements.requiredB),
          现状: elements.currentB.value + '㎡',
          缺额: getValue(elements.deficitB)
        },
        {
          类型: '生活配套用房（C）',
          应配建: getValue(elements.requiredC),
          现状: elements.currentC.value + '㎡',
          缺额: getValue(elements.deficitC)
        },
        {
          类型: '学生宿舍（c1）',
          应配建: getValue(elements.requiredC1),
          现状: elements.currentC1.value + '㎡',
          缺额: getValue(elements.deficitC1)
        },
        {
          类型: '其他生活用房（c2）',
          应配建: getValue(elements.requiredC2),
          现状: elements.currentC2.value + '㎡',
          缺额: getValue(elements.deficitC2)
        },
        {
          类型: '后勤辅助用房（D）',
          应配建: getValue(elements.requiredD),
          现状: elements.currentD.value + '㎡',
          缺额: getValue(elements.deficitD)
        }
      ];
      
      // 构建CSV内容
      let csvContent = "学校建筑规模测算结果\n";
      csvContent += `学校类型,${schoolTypeText}\n\n`;
      
      csvContent += "学生数量统计,\n";
      Object.entries(studentData).forEach(([key, value]) => {
        csvContent += `${key},${value}人\n`;
      });
      
      csvContent += `\n补贴总面积,${subsidyArea}\n\n`;
      
      csvContent += "用房类型,应配建规模,现状面积,缺额\n";
      buildingData.forEach(item => {
        csvContent += `${item.类型},${item.应配建},${item.现状},${item.缺额}\n`;
      });
      
      csvContent += `\n总体缺额,${getValue(elements.totalDeficit)}\n`;
      csvContent += `含补贴总体缺额,${getValue(elements.totalDeficitWithSubsidy)}\n`;
      
      // 创建并下载CSV文件
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('href', url);
      a.setAttribute('download', `学校建筑规模测算_${new Date().toLocaleDateString()}.csv`);
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
    
    // 初始化
    updateIntlTotal();
    updateTotalSubsidy();
    
    // 核心计算函数（严格遵循C = c1 + c2逻辑）
    function calculateDeficit() {
      // 获取学校类型
      const schoolType = document.querySelector('input[name="schoolType"]:checked').value;
      const base = indicators[schoolType];
      
      // 获取学生数量
      const counts = {
        undergrad: parseInt(elements.undergraduates.value) || 0,
        masters: parseInt(elements.masters.value) || 0,
        doctors: parseInt(elements.doctors.value) || 0,
        intlUndergrad: parseInt(elements.intlUndergrad.value) || 0,
        intlMasters: parseInt(elements.intlMasters.value) || 0,
        intlDoctors: parseInt(elements.intlDoctors.value) || 0
      };
      
      // 初始化需求变量（确保required.C = required.C1 + required.C2）
      let required = { A: 0, B: 0, C: 0, C1: 0, C2: 0, D: 0 };
      
      // 1. 本专科生（基础指标）
      required.A += counts.undergrad * base.A;
      required.B += counts.undergrad * base.B;
      required.C1 += counts.undergrad * base.C1;  // 基础宿舍
      required.C2 += counts.undergrad * base.C2;  // 基础其他生活用房
      
      // 2. 硕士生（本专科基础 + 额外补贴）
      required.A += counts.masters * (base.A + 3);  // 基础A + 额外3
      required.B += counts.masters * (base.B + 2);  // 基础B + 额外2
      required.C1 += counts.masters * (base.C1 + 5);  // 基础宿舍 + 额外5
      required.C2 += counts.masters * base.C2;        // 基础其他生活用房
      
      // 3. 博士生（本专科基础 + 额外补贴）
      required.A += counts.doctors * (base.A + 3);   // 基础A + 额外3
      required.B += counts.doctors * (base.B + 2);   // 基础B + 额外2
      required.C1 += counts.doctors * (base.C1 + 14); // 基础宿舍 + 额外14
      required.C2 += counts.doctors * base.C2;        // 基础其他生活用房
      
      // 4. 本科留学生（本专科基础 + c2额外补贴）
      required.A += counts.intlUndergrad * base.A;
      required.B += counts.intlUndergrad * base.B;
      required.C1 += counts.intlUndergrad * base.C1;  // 基础宿舍
      required.C2 += counts.intlUndergrad * (base.C2 + 19);  // 基础其他 + 额外19
      
      // 5. 硕士留学生（本专科基础 + 硕士生补贴 + 额外c2）
      required.A += counts.intlMasters * (base.A + 3);  // 基础A + 额外3
      required.B += counts.intlMasters * (base.B + 2);  // 基础B + 额外2
      required.C1 += counts.intlMasters * (base.C1 + 5);  // 基础宿舍 + 额外5
      required.C2 += counts.intlMasters * (base.C2 + 19); // 基础其他 + 额外19
      
      // 6. 博士留学生（本专科基础 + 博士生补贴 + 额外c2）
      required.A += counts.intlDoctors * (base.A + 3);   // 基础A + 额外3
      required.B += counts.intlDoctors * (base.B + 2);   // 基础B + 额外2
      required.C1 += counts.intlDoctors * (base.C1 + 14); // 基础宿舍 + 额外14
      required.C2 += counts.intlDoctors * (base.C2 + 19); // 基础其他 + 额外19
      
      // 7. 后勤辅助用房（所有学生共用基础指标）
      required.D += (
        counts.undergrad + counts.masters + counts.doctors +
        counts.intlUndergrad + counts.intlMasters + counts.intlDoctors
      ) * base.D;
      
      // 关键逻辑：确保生活配套用房C等于c1+c2
      required.C = required.C1 + required.C2;
      
      // 获取现状面积
      const current = {
        A: parseInt(elements.currentA.value) || 0,
        B: parseInt(elements.currentB.value) || 0,
        C: parseInt(elements.currentC.value) || 0,
        C1: parseInt(elements.currentC1.value) || 0,
        C2: parseInt(elements.currentC2.value) || 0,
        D: parseInt(elements.currentD.value) || 0
      };
      
      // 计算缺额（严格基于需求与现状的差值）
      const deficit = {
        A: required.A - current.A,
        B: required.B - current.B,
        C: required.C - current.C,  // C缺额 = (c1需求 + c2需求) - 现状C
        C1: required.C1 - current.C1,  // c1缺额单独计算
        C2: required.C2 - current.C2,  // c2缺额单独计算
        D: required.D - current.D
      };
      
      // 计算补贴总额
      const subsidyCount = elements.subsidyList.querySelectorAll('.subsidy-item').length;
      const totalSubsidy = subsidyCount * 3000;
      
      // 计算总体缺额（A、B、C、D的实际差值总和，包含正负）
      const totalDeficit = [deficit.A, deficit.B, deficit.C, deficit.D].reduce((sum, val) => sum + val, 0);
      
      // 计算总应配建规模（不含补贴）
      const totalRequired = required.A + required.B + required.C + required.D ;
      
      // 更新含补贴总体缺额
      const totalDeficitWithSubsidy = totalRequired - (current.A + current.B + current.C + current.D - totalSubsidy);
      
      // 格式化显示函数
      function formatValue(value) {
        const formatted = value.toFixed(2);
        if (formatted > 0) return `<span class="text-danger">+${formatted}㎡</span>`;
        if (formatted < 0) return `<span class="text-success">${formatted}㎡</span>`;
        return '0.00㎡';
      }
      
      // 更新缺额显示
      elements.deficitA.innerHTML = formatValue(deficit.A);
      elements.deficitB.innerHTML = formatValue(deficit.B);
      elements.deficitC.innerHTML = formatValue(deficit.C);
      elements.deficitC1.innerHTML = formatValue(deficit.C1);
      elements.deficitC2.innerHTML = formatValue(deficit.C2);
      elements.deficitD.innerHTML = formatValue(deficit.D);
      
      // 更新总体缺额
      elements.totalDeficit.textContent = `${totalDeficit.toFixed(2)}㎡`;
      elements.totalDeficitWithSubsidy.textContent = `${totalDeficitWithSubsidy.toFixed(2)}㎡`;
      
      // 更新应配建规模（展示C = c1 + c2的结果）
      elements.requiredA.textContent = `${required.A.toFixed(2)}㎡`;
      elements.requiredB.textContent = `${required.B.toFixed(2)}㎡`;
      elements.requiredC.textContent = `${required.C.toFixed(2)}㎡`;
      elements.requiredC1.textContent = `${required.C1.toFixed(2)}㎡`;
      elements.requiredC2.textContent = `${required.C2.toFixed(2)}㎡`;
      elements.requiredD.textContent = `${required.D.toFixed(2)}㎡`;
      elements.totalRequired.textContent = `${totalRequired.toFixed(2)}㎡`;
      
      // 计算完成动画反馈
      elements.calculateBtn.classList.add('bg-success');
      elements.calculateBtn.innerHTML = '<i class="fa fa-check mr-2"></i>计算完成';
      setTimeout(() => {
        elements.calculateBtn.classList.remove('bg-success');
        elements.calculateBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>计算缺额';
      }, 1500);
    }
  </script>
</body>
</html>